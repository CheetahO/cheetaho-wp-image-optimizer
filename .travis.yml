sudo: false
dist: trusty

language: php

notifications:
  slack: cheetaho:nDKXE1Y604QWJ1fK2TnTPIgH
  email:
    on_success: never
    on_failure: change

branches:
  only:
    - master
    - dev

cache:
  directories:
    - $HOME/.composer/cache

stages:
  - name: test
  - ðŸš€ deployment

jobs:
  fast_finish: true
  include:
    - php: 7.2
      #env: WP_VERSION=5.0 WP_MULTISITE=1 PHPLINT=1 PHPCS=1
      #env: WP_VERSION=latest WP_MULTISITE=1 WPSNIFF=1
      env: WP_VERSION=latest
    - php: 7.1
      env: WP_VERSION=latest
   # - php: 7.0
  #    env: WP_VERSION=latest
  #  - php: 5.6
  #    env: WP_VERSION=3.2.1
  #  - php: 5.6
  #    env: WP_VERSION=trunk
    - stage: ðŸš€ deployment
      name: "Deploy to WordPress"
      php: 7.2
      if: branch = dev
      deploy:
        #
        # Auto-deploys the built plugin to WordPress.org on push to master branch
        #
        provider: script
        skip_cleanup: true
        script: bash ./bin/deploy.sh
        on:
          php: 7.2
          branch: dev

before_script:
  - export PATH="$HOME/.composer/vendor/bin:$PATH"
  - |
    if [ -f ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/xdebug.ini ]; then
      phpenv config-rm xdebug.ini
    else
      echo "xdebug.ini does not exist"
    fi
  - |
    if [[ ! -z "$WP_VERSION" ]] ; then
      bash bin/install-wp-tests.sh wordpress_test root '' localhost $WP_VERSION false $CHEETAHO_API_KEY
      composer global require "phpunit/phpunit=4.8.*|5.7.*"
    fi
  - |
    if [[ "$WPSNIFF" == "1" ]] ; then
      composer global require wp-coding-standards/wpcs dealerdirect/phpcodesniffer-composer-installer
      phpcs --config-set installed_paths $HOME/.composer/vendor/wp-coding-standards/wpcs
    fi

script:
  - if [[ "$WPSNIFF" == "1" ]]; then phpcs --standard=phpcs.ruleset.xml --extensions=php .; fi
  - phpunit

